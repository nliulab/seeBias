---
title: "seeBias: Fairness Evaluation and Visualisation"
output: 
  github_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, cache = FALSE,
                      fig.width = 10, fig.height = 6)
```

## Demo

Use subset of COMPAS data for Caucasian and African American. Exclude race and 
sex from the prediction model.

```{r}
library(dplyr)
library(seeBias)
# Load example data
data("compas")
head(compas)
table(compas$Two_yr_Recidivism, compas$Ethnicity)
compas <- compas %>% filter(Ethnicity %in% c("Caucasian", "African_American"))
compas$Ethnicity <- ifelse(compas$Ethnicity == "African_American",
                           "African American", as.character(compas$Ethnicity))
m <- compas %>% select(-Ethnicity, -Sex) %>% 
  glm(Two_yr_Recidivism ~ ., data = ., family = "binomial")
knitr::kable(summary(m)$coef, digits = 3)
```

### Fairness metrics

Use race and gender as sensitive variables.

```{r}
# Extracted predicted risk and observations from test data.
# If not specified, the best threshold in ROC analysis is used.
x <- compas %>% select(Ethnicity, Sex) %>% evaluate_prediction_prob(
  y_pred = predict(m, newdata = compas, type = "response"), 
  y_obs = compas$Two_yr_Recidivism, y_pos = "1",
  sens_var = ., sens_var_ref = c("Caucasian", "Male")
)
```

Quantify fairness:

```{r results='asis'}
summary(x)
```

### Visualisation of fairness metrics

```{r}
x_plots <- plot(x)
```


```{r, fig.width=4, fig.height=4}
x_plots$`ROC curves`
x_plots$`Calibration in the large`
x_plots$`Calibration curves`
x_plots$`Boxplot of predictions`
x_plots$`Numbers needed for true positive`
x_plots$`Numbers needed for true negative`
```

### Alternative color scheme

```{r}
x_plots$`Performance metrics` + ggsci::scale_fill_npg()
```

```{r, fig.width=7, fig.height=4}
x_plots$`ROC curves` + ggsci::scale_color_npg()
x_plots$`Calibration in the large` + ggsci::scale_fill_npg()
x_plots$`Calibration curves` + ggsci::scale_color_npg()
x_plots$`Boxplot of predictions` + ggsci::scale_color_npg()
x_plots$`Numbers needed for true positive` + ggsci::scale_color_npg()
x_plots$`Numbers needed for true negative` + ggsci::scale_color_npg()
```
